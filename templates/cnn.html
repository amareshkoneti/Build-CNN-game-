<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic CNN Builder</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .btn-link {
        display: inline-block;
        background-color: #4CAF50;
        color: white;
        font-size: 1rem;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 30px;
        }

        .btn-link:hover {
            background-color: #45a049;
        }
        .layer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .layer-block {
            margin: 10px;
            padding: 20px;
            width: 250px;
            color: white;
            font-weight: bold;
            text-align: center;
            position: relative;
            border-radius: 10px;
        }
        .conv2d { background-color: #3498db; }  /* Blue */
        .maxpool { background-color: #2ecc71; } /* Green */
        .dense { background-color: #f1c40f; }  /* Yellow */
        .flatten { background-color: #95a5a6;  } /* Gray */
        .dropout { background-color: #e67e22; } /* Orange */
        .input { background-color: #9b59b6; }  /* Purple */
        .output { background-color: #e74c3c; } /* Red */
        .arrow {
            width: 2px;
            height: 20px;
            background-color: black;
            margin: 5px auto;
        }
        .button-container {
            margin-top: 20px;
        }
        button {
            background-color: #007bff; /* Bootstrap Blue */
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        button:hover {
            background-color: #0056b3; /* Darker Blue */
            transform: scale(1.05);
        }

        button:active {
            background-color: #003d80; /* Even Darker Blue */
            transform: scale(0.95);
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Button container styling */
        .button-container {
            margin-top: 20px;
        }

        .accuracy-container {
            margin-top: 20px;
            font-weight: bold;
            color: green;
        }

    </style>
</head>
<body>
    <h1>Build Your CNN Model</h1>

    <!-- Layer Selection -->
    <div>
        <h3>Select Layers:</h3>
        <button onclick="addLayer('Conv2D')">Add Conv2D</button>
        <button onclick="addLayer('MaxPooling2D')">Add MaxPooling2D</button>
        <button onclick="addLayer('Flatten')">Add Flatten</button>
        <button onclick="addLayer('Dense')">Add Dense</button>
        <button onclick="addLayer('Dropout')">Add Dropout</button>
    </div>

    <!-- Display the layers visually -->
    <h3>Model Architecture:</h3>
    <div class="layer-container" id="layer-container">
        <div class="layer-block input">Input Layer</div>
    </div>

    <!-- Train & Save Model -->
    <div class="button-container">
        <button onclick="trainAndSaveModel()">Train & Save Model</button>
    </div>

    <!-- Modal for Accuracy Display -->
    <div id="accuracy-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Hurreyy..! here is your Score</h2>
            <p id="accuracy-details"></p>
        </div>
    </div>

    <a href="{{ url_for('uploadimage') }}" class="btn-link">Test Your Model</a>
    <script>
        let layers = [];

        function addLayer(layerType) {
            let layer = { type: layerType, options: {} };
            layers.push(layer);
            updateLayerDisplay();
        }

        function updateLayerDisplay() {
            let container = document.getElementById('layer-container');
            container.innerHTML = '<div class="layer-block input">Input Layer</div>';

            layers.forEach((layer, index) => {
                let div = document.createElement('div');
                div.classList.add('layer-block');

                // Assign colors based on layer type
                if (layer.type === 'Conv2D') {
                    div.classList.add('conv2d');
                    div.innerHTML = `<p>Conv2D</p>${createLayerOptions(layer, index)}`;
                }
                if (layer.type === 'MaxPooling2D') {
                    div.classList.add('maxpool');
                    div.innerHTML = `<p>MaxPooling2D</p>`;
                }
                if (layer.type === 'Flatten') {
                    div.classList.add('flatten');
                    div.innerHTML = `<p>Flattening</p>`;
                }

                if (layer.type === 'Dense') {
                    div.classList.add('dense');
                    div.innerHTML = `<p>Dense</p>${createLayerOptions(layer, index)}`;
                }
                if (layer.type === 'Dropout') {
                    div.classList.add('dropout');
                    div.innerHTML = `<p>Dropout</p>${createLayerOptions(layer, index)}`;
                }

                container.appendChild(div);
                container.innerHTML += '<div class="arrow"></div>';
            });

            container.innerHTML += '<div class="layer-block output">Output Layer</div>';
        }

        function createLayerOptions(layer, index) {
            if (layer.type === 'Conv2D') {
                return ` 
                    <div class="layer-options">
                        <label for="filters-${index}">Filters:</label>
                        <input type="number" id="filters-${index}" value="32">
                        <label for="activation-${index}">Activation:</label>
                        <select id="activation-${index}">
                            <option value="relu">ReLU</option>
                            <option value="sigmoid">Sigmoid</option>
                            <option value="tanh">Tanh</option>
                            <option value="softmax">Softmax</option>
                        </select>
                    </div>`;
            }
            if (layer.type === 'Dense') {
                return `
                    <div class="layer-options">
                        <label for="units-${index}">Units:</label>
                        <input type="number" id="units-${index}" value="128">
                        <label for="activation-dense-${index}">Activation:</label>
                        <select id="activation-dense-${index}">
                            <option value="relu">ReLU</option>
                            <option value="sigmoid">Sigmoid</option>
                            <option value="tanh">Tanh</option>
                            <option value="softmax">Softmax</option>
                        </select>
                    </div>`;
            }
            if (layer.type === 'Dropout') {
                return `
                    <div class="layer-options">
                        <label for="rate-${index}">Dropout Rate:</label>
                        <input type="number" id="rate-${index}" value="0.5" step="0.1" max="1" min="0">
                    </div>`;
            }
            return '';
        }

        function trainAndSaveModel() {
            // Collect selected parameters for each layer
            layers = layers.map((layer, index) => {
                if (layer.type === 'Conv2D') {
                    layer.options.filters = document.getElementById(`filters-${index}`).value;
                    layer.options.activation = document.getElementById(`activation-${index}`).value;
                }
                if (layer.type === 'Dense') {
                    layer.options.units = document.getElementById(`units-${index}`).value;
                    layer.options.activation = document.getElementById(`activation-dense-${index}`).value;
                }
                if (layer.type === 'Dropout') {
                    layer.options.rate = document.getElementById(`rate-${index}`).value;
                }
                return layer;
            });

            fetch('/train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ layers: layers })
            })
            .then(response => response.json())
            .then(data => {
                // Show modal with accuracy details
                let accuracyDetails = `
                    <p>Model trained successfully!</p>
                    <p>Training Accuracy: <strong>${data.train_accuracy}%</strong></p>
                    <p>Validation Accuracy: <strong>${data.validation_accuracy}%</strong></p>`;
                document.getElementById('accuracy-details').innerHTML = accuracyDetails;
                document.getElementById('accuracy-modal').style.display = "block";
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function closeModal() {
            document.getElementById('accuracy-modal').style.display = "none";
        }
    </script>
</body>
